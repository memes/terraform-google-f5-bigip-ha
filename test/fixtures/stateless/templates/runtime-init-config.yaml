# Minimal onboarding template for automate testing of BIG-IP HA clusters; only the management interface (nic1) and first
# data-plane interface (nic0) will be configured. This is NOT a full example or suitable for production use.
# yamllint disable-line rule:line-length
# yaml-language-server: $schema=https://raw.githubusercontent.com/F5Networks/f5-bigip-runtime-init/1.5.2/src/schema/base_schema.json
# spell-checker: disable
# Generated by f5-google-declaration-generator snapshot at 2024-05-17T13:42:59-07:00
controls:
  logLevel: info
  extensionInstallDelayInMs: 60000
pre_onboard_enabled:
  - name: provision_rest
    type: inline
    commands:
      - /usr/bin/setdb provision.extramb 1000 || true
      - /usr/bin/setdb provision.restjavad.extramb 1384 || /usr/bin/setdb restjavad.useextramb true || true
      - /usr/bin/setdb iapplxrpm.timeout 300 || true
      - /usr/bin/setdb icrd.timeout 180 || true
      - /usr/bin/setdb restjavad.timeout 180 || true
      - /usr/bin/setdb restnoded.timeout 180 || true
extension_packages:
  install_operations:
    - extensionType: do
      extensionHash: 5e58bc15a4c436494599dfc509c87f02400339e6c0ce8275df259d5f1585146b
      extensionVersion: 1.34.0
      # yamllint disable-line rule:line-length
      extensionUrl: https://github.com/F5Networks/f5-declarative-onboarding/releases/download/v1.34.0/f5-declarative-onboarding-1.34.0-5.noarch.rpm
    - extensionType: as3
      extensionHash: ced0948208f4dc29af7c0ea3a925a28bf8b8690a263588374e3c3d2689999490
      extensionVersion: 3.41.0
      # yamllint disable-line rule:line-length
      extensionUrl: https://github.com/F5Networks/f5-appsvcs-extension/releases/download/v3.41.0/f5-appsvcs-3.41.0-1.noarch.rpm
extension_services:
  service_operations:
    - extensionType: do
      type: inline
      value:
        # yamllint disable-line rule:line-length
        $schema: https://raw.githubusercontent.com/F5Networks/f5-declarative-onboarding/v1.34.0/src/schema/1.34.0/base.schema.json
        schemaVersion: 1.34.0
        class: Device
        async: true
        label: f5-google-declaration-generator
        Common:
          class: Tenant
          system:
            class: System
            autoPhonehome: false
            hostname: '{{{ INSTANCE_NAME }}}.{{{ DOMAIN_NAME }}}'
          dns:
            class: DNS
            nameServers:
              - 169.254.169.254
          ntp:
            class: NTP
            timezone: UTC
            servers:
              - 169.254.169.254
          admin:
            class: User
            userType: regular
            password: '{{{ ADMIN_PASSWORD }}}'
            shell: bash
            keys: ["{{{ SSH_KEYS }}}"]
          external:
            class: VLAN
            tag: 4094
            mtu: '{{{ EXTERNAL_MTU }}}'
            interfaces:
              - name: '1.0'
                tagged: false
          external_self_ip:
            class: SelfIp
            address: '{{{ EXTERNAL_ADDRESS }}}/32'
            vlan: external
            allowService:
              - 'tcp:80'
              - 'tcp:443'
              - 'tcp:4353'
              - 'udp:1026'
            trafficGroup: traffic-group-local-only
          external_gw_rt:
            class: Route
            target: external
            network: '{{{ EXTERNAL_GATEWAY_ADDRESS }}}/32'
            mtu: '{{{ EXTERNAL_MTU }}}'
          default:
            class: Route
            gw: '{{{ EXTERNAL_GATEWAY_ADDRESS }}}'
            network: 'default'
            mtu: '{{{ EXTERNAL_MTU }}}'
          provision:
            class: Provision
            ltm: nominal
    - extensionType: as3
      type: inline
      value:
        class: AS3
        action: deploy
        logLevel: info
        persist: true
        declaration:
          class: ADC
          $schema: https://raw.githubusercontent.com/F5Networks/f5-appsvcs-extension/main/schema/3.41.0/as3-schema.json
          schemaVersion: 3.41.0
          label: f5-google-declaration-generator
          Common:
            class: Tenant
            Shared:
              class: Application
              template: shared
              external_self_ip:
                class: Service_Address
                virtualAddress: '{{{ EXTERNAL_ADDRESS }}}'
              hc_respond_200:
                class: iRule
                label: health-check-responder
                remark: Simple HTTP responder for GCP health checks
                iRule: >-
                  when HTTP_REQUEST { HTTP::respond 200 content OK Content-Type text/plain }
              livez:
                class: Service_HTTP
                remark: Return a 200 status code to confirm this instance is alive
                iRules:
                  - use: /Common/Shared/hc_respond_200
                virtualPort: 26000
                shareAddresses: true
                virtualAddresses:
                  - use: /Common/Shared/external_self_ip
post_onboard_enabled:
  - name: save_config
    type: inline
    commands:
      - tmsh save sys config
runtime_parameters:
  - name: DOMAIN_NAME
    type: static
    value: local
  - name: ADMIN_PASSWORD
    type: static
    value: '${admin_password}'
  - name: SSH_KEYS
    type: static
    value: '${pubkey}'
  - name: BIG_IP_HA_PEER_NAME
    type: url
    value: http://169.254.169.254/computeMetadata/v1/instance/attributes/bigip_ha_peer_name
    returnType: string
    headers:
      - name: Metadata-Flavor
        value: Google
  - name: BIG_IP_HA_PEER_ADDRESS
    type: url
    value: http://169.254.169.254/computeMetadata/v1/instance/attributes/bigip_ha_peer_address
    returnType: string
    headers:
      - name: Metadata-Flavor
        value: Google
  - name: BIG_IP_HA_PEER_OWNER_INDEX
    type: url
    value: http://169.254.169.254/computeMetadata/v1/instance/attributes/bigip_ha_peer_owner_index
    returnType: string
    headers:
      - name: Metadata-Flavor
        value: Google
  - name: INSTANCE_NAME
    type: url
    value: http://169.254.169.254/computeMetadata/v1/instance/name
    returnType: string
    headers:
      - name: Metadata-Flavor
        value: Google
  - name: EXTERNAL_ADDRESS
    type: metadata
    metadataProvider:
      environment: gcp
      type: network
      index: 0
      field: ip
      ipcalc: address
  - name: EXTERNAL_GATEWAY_ADDRESS
    type: metadata
    metadataProvider:
      environment: gcp
      type: network
      field: ip
      index: 0
      ipcalc: first
  - name: EXTERNAL_MTU
    type: url
    value: http://169.254.169.254/computeMetadata/v1/instance/network-interfaces/0/?recursive=true
    query: mtu
    returnType: number
    headers:
      - name: Metadata-Flavor
        value: Google
  - name: EXTERNAL_NETWORK_ADDRESS
    type: metadata
    metadataProvider:
      environment: gcp
      type: network
      index: 0
      field: ip
      ipcalc: base
  - name: EXTERNAL_NETWORK_BITMASK
    type: metadata
    metadataProvider:
      environment: gcp
      type: network
      index: 0
      field: ip
      ipcalc: bitmask
